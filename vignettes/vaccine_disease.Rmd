---
title: "Vaccines and Infectious Disease"
author: Aris Paschalidis
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vaccines and Infectious Disease}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(CAvaccines)
library(ggplot2)
```

# Read in Data
The first step in any analysis we want to perform is to first read in our datasets.
For this analysis, we will utilize three datasets both found in the Data/ folder
of this project: school_vaccination, county_vaccination, and pertussis. All three 
of these datasets are documented in the associated help files, but we summarize here
for convenience. Before continuing with this vignette, we strongly encourage readers
to examine the documentation for each dataset, if they have not already.

* `school_vaccination` is a dataset that contains detailed information 
about vaccination rates for several thousand schools in CA. 
* `county_vaccination` is a related dataset to school_vaccination. It
contains information about vaccination rates for each CA county.
* `pertussis` is a dataset containing all pertussis cases, arranged by 
county, from the years of 2008-2009 in the state of California.

One approach to examining our data is to study the variable names. 

```{r}
# We print the names of each dataset
names(county_vaccination)
names(pertussis)
```

Another, likely more useful option, is to visualize our data. To do this, we 
will create plots of our variables. We first start by creating maps of CA counties
and shading the counties according to a specific measurement. The following set
of graphs shows the percent of students with DTP vaccinations, the percent
of students that are up to date on their vaccinations, the percent of students
that have a PME, and the percent of students that have a PBE.

```{r}
percents <- dplyr::filter(county_vaccination, Year == "2017")
percents <- dplyr::select(percents, Jurisdiction, total_Enrollment, total_DTP, total_Up_to_Date, total_PME, total_PBE)

percents$total_DTP        <- with(percents, total_DTP/total_Enrollment*100) 
percents$total_Up_to_Date <- with(percents, total_Up_to_Date/total_Enrollment*100) 
percents$total_PME        <- with(percents, total_PME/total_Enrollment*100) 
percents$total_PBE        <- with(percents, total_PBE/total_Enrollment*100) 

map_plot(percents, "total_DTP", "Total DTP Vaccinations")
map_plot(percents, "total_Up_to_Date", "Total Up to Date")
map_plot(percents, "total_PME", "Total PME")
map_plot(percents, "total_PBE", "Total PBE")
```

```{r}
ggplot(pertussis, aes(x = Year, y = Cases)) + geom_boxplot()

means <- as.data.frame(pertussis %>% dplyr::group_by(Year) %>% dplyr::summarize(Average = mean(Cases)))
ggplot(means, aes(x = Year, y = Average, fill = Average)) + geom_col() + theme(legend.position = "none")
```

# Modeling

```{r}
model_data  <- merge(county_vaccination, pertussis, by = c("Jurisdiction", "Year"))
scaled_data <- model_data %>% dplyr::select(-one_of(c("Jurisdiction"))) %>% dplyr::mutate_if(is.numeric, scale) %>% as.data.frame()

# set.seed(103)
sample = caTools::sample.split(scaled_data$Cases, SplitRatio = 0.7)
train = subset(scaled_data, sample == TRUE)
test  = subset(scaled_data, sample == FALSE)

lm <- stats::lm(Cases ~ ., data = train)
summary(lm)

predict_lm <- lm %>% stats::predict(test)
caret::R2(predict_lm, test$Cases)

cart <- rpart::rpart(Cases ~ ., data = train)
# prune_cart <- rpart::prune(cart, cp = cart$cptable[which.min(cart$cptable[,"xerror"]),"CP"])

predict_cart <- cart %>% stats::predict(test)
confMat <- table(test$Cases, predict_cart)
sum(diag(confMat))/sum(confMat)
```

```{r}
corr_mat <- Hmisc::rcorr(as.matrix(scaled_data), type = "spearman")
M <- corr_mat$r
P_mat <- corr_mat$P

corrplot::corrplot(M, method = "color", col = RColorBrewer::brewer.pal(n=8, name="PuBu"),
  addCoef.col = "black",
  tl.col = "black", tl.srt = 50,tl.cex = 0.60,
  p.mat = P_mat, sig.level = 0.05, pch.cex = 5,
  mar=c(0,0,2,0), number.cex = 1)
```



